<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Assemble sBPF ASM</title>
	<style>
		body {
			font-family: monospace;
			max-width: 800px;
			margin: 20px auto;
			padding: 0 20px;
		}
		#editor {
			width: 100%;
			height: 300px;
			margin: 10px 0;
			font-family: monospace;
			padding: 10px;
		}
		#output {
			white-space: pre-wrap;
			background: #f5f5f5;
			padding: 10px;
			border-radius: 4px;
			margin-top: 10px;
		}
		button {
			padding: 8px 16px;
			font-size: 16px;
			cursor: pointer;
			margin-right: 10px;
		}
		.button-group {
			margin: 10px 0;
		}
	</style>
</head>
<body>
	<h1>sBPF Assembly Editor</h1>
	<textarea id="editor" placeholder="Enter your sBPF assembly code here..."></textarea>
	<div class="button-group">
		<button id="assemble-button">Assemble</button>
		<button id="download-button" style="display: none;">Download .so</button>
	</div>
	<div id="output"></div>
	<script type="module">
		import init, {assemble} from "./wasm/helios_vm.js";
		let lastGeneratedBytes = null;

		async function runWasm() {
			const output = document.getElementById("output");
			const editor = document.getElementById("editor");
			const downloadButton = document.getElementById("download-button");

			// Initialize WASM module
			await init();

			try {
				const result = assemble(editor.value);
				lastGeneratedBytes = result;
				output.textContent = `Assembly successful! Click 'Download .so' to save the file.`;
				downloadButton.style.display = 'inline-block';
			} catch (error) {
				output.textContent = `Error: ${error}`;
				downloadButton.style.display = 'none';
			}
		}

		function downloadSoFile() {
			if (!lastGeneratedBytes) {
				return;
			}

			// Create a blob from the bytes
			const blob = new Blob([lastGeneratedBytes], { type: 'application/octet-stream' });
			
			// Create a download link
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = 'program.so';
			
			// Trigger the download
			document.body.appendChild(a);
			a.click();
			
			// Cleanup
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}

		document.getElementById("assemble-button").addEventListener("click", runWasm);
		document.getElementById("download-button").addEventListener("click", downloadSoFile);
	</script>
</body>
</html>
